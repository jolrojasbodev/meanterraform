{
  "variables": {
    "default_ssh_username": "ubuntu",
    "app_version": "1.0.0",
    "default_instance_type": "t2.micro",
    "default_subnet_id": "subnet-06174b84225a8d35b",
    "ubuntu_2004_source_image": "ubuntu-2004-focal-v20250425",
    "aws_region": "us-east-2",
    "aws_access_key": "AKIAVDSU4RBGYKKQ4IE7",
    "aws_secret_key": "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",
    "default_aws_source_ami": "ami-0c3b809fcf2445b6a",
    "webapp_security_group_id": "sg-0ffc09b6668901f1a"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "ami_name": "mongodbformean-{{timestamp}}",
      "associate_public_ip_address": true,
      "instance_type": "{{user `default_instance_type`}}",
      "communicator": "ssh",
      "region": "{{user `aws_region`}}",
      "source_ami": "{{user `default_aws_source_ami`}}",
      "ssh_username": "{{user `default_ssh_username`}}",
      "ssh_pty": true,
      "tags": {
        "App_Version": "{{user `app_version`}}",
        "Name": "MongoDB",
        "OS_Version": "Ubuntu 20.04",
        "Release": "Latest"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "echo '### Instalando dependencias básicas ###'",
        "sudo apt-get update -y",
        "sudo apt-get install -y gnupg wget"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo '### Configurando repositorio de MongoDB 6.0 ###'",
        "wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb.gpg",
        "echo \"deb [ arch=amd64 signed-by=/usr/share/keyrings/mongodb.gpg ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse\" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list",
        "sudo apt-get update -y"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo '### Instalando MongoDB ###'",
        "sudo apt-get install -y mongodb-org",
        "echo '### Preparando configuración personalizada ###'",
        "sudo mkdir -p /etc/systemd/system/mongod.service.d/"
      ]
    },
    {
      "type": "file",
      "source": "mongod.conf",
      "destination": "/tmp/mongod-custom.conf"
    },
    {
      "type": "shell",
      "inline": [
        "echo '### Configurando servicio MongoDB ###'",
        "sudo mv /tmp/mongod-custom.conf /etc/mongod-custom.conf",
        "sudo chown root:root /etc/mongod-custom.conf",
        "sudo chmod 644 /etc/mongod-custom.conf",
        "echo '[Service]' | sudo tee /etc/systemd/system/mongod.service.d/override.conf",
        "echo 'ExecStart=' | sudo tee -a /etc/systemd/system/mongod.service.d/override.conf",
        "echo 'ExecStart=/usr/bin/mongod --config /etc/mongod-custom.conf' | sudo tee -a /etc/systemd/system/mongod.service.d/override.conf",
        "sudo systemctl daemon-reload"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo '### Iniciando MongoDB ###'",
        "sudo systemctl start mongod",
        "sudo systemctl enable mongod",
        "echo '### Esperando 15 segundos para inicialización...'",
        "sleep 15",
        "echo '### Creando usuario admin ###'",
        "mongosh \"mongodb://localhost:27017/admin\" --eval 'db.createUser({user: \"admin\", pwd: \"password123\", roles: [\"root\"]}) || true'"
      ]
    }
  ]
}